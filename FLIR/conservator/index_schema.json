{
  "$schema": "http://json-schema.org/draft-07/schema",
  "title": "FLIR Conservator schema v1",
  "description": "schema for datasets and videos",

  "definitions": {
    "noNull": {
      "$id": "#noNull",
      "type": "string",
      "minLength": 1
    },
    "nonNegative": {
      "$id": "#noNull",
      "type": "integer",
      "minimum": 0
    },
    "documentId": {
      "comment": "leaves out chars like O and 0 that can be easily confused",
      "$id": "#documentId",
      "type": "string",
      "pattern": "^[23456789ABCDEFGHJKLMNPQRSTWXYZabcdefghijkmnopqrstuvwxyz]{17}$"
    },
    "md5hash": {
      "$id": "#md5hash",
      "type": "string",
      "pattern": "^[a-f0-9]{32}$"
    },
    "labelString": {
      "$id": "#labelString",
      "type": "string",
      "pattern": "^[0-9a-zA-Z!@#$%^&*()_+=;',.<>?:{}`~| \\[\\]/-]+$"
    },
    "tagString": {
      "comment": "Matches non-empty string with a-z, 0-9, space (' '), hyphen/dash/minus ('-'), and underscore ('_').",
      "$id": "#tagString",
      "type": "string",
      "pattern": "^[-a-z0-9 _]+$"
    },
    "email": {
      "type": "string",
      "pattern": "^([a-z0-9_-]+[.+])*[a-z0-9_-]+@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)+[a-z]{2,}$"
    },
    "custom": {
      "comment": "free-form object",
      "type": "object",
      "additionalProperties": true
    },
    "boundingBox": {
      "$id": "#boundingBox",
      "type": "object",
      "required": ["x", "y", "w", "h"],
      "properties": {
        "x": {"type": "integer"},
        "y": {"type": "integer"},
        "w": {"type": "integer"},
        "h": {"type": "integer"}
      },
      "additionalProperties": false
    },
    "point": {
      "$id": "#point",
      "type": "object",
      "required": ["x", "y"],
      "properties": {
        "x": {"type": "integer"},
        "y": {"type": "integer"}
      },
      "additionalProperties": false
    },
    "annotation": {
      "$id": "#annotation",
      "type": "object",
      "required": ["labels"],
      "properties": {
        "targetId": {"$ref": "#/definitions/noNull"},
        "labels": {
          "comment": "one or more label strings",
          "type": "array",
          "items": [
            {"$ref": "#/definitions/labelString"}
          ],
          "additionalItems": {"$ref": "#/definitions/labelString"}
        },
        "source": {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["human", "unknown", "machine"]
            },
            "meta": {
              "comment": "free-form object",
              "type": "object",
              "additionalProperties": true
            }
          },
          "additionalProperties": false
        },
        "boundingBox": {"$ref": "#/definitions/boundingBox"},
        "boundingPolygon": {
          "type": "array",
          "items": {"$ref": "#/definitions/point"}
        },
        "point": {"$ref": "#/definitions/point"},
        "attributes": {
          "type": "array",
          "items": {"$ref": "#/definitions/attribute"}
        },
        "custom": {"$ref": "#/definitions/custom"}
      },
      "additionalProperties": false
    },
    "attribute": {
      "$id": "#attribute",
      "type": "object",
      "required": ["name", "value"],
      "properties": {
        "name": {"$ref": "#/definitions/noNull"},
        "value": {"$ref": "#/definitions/noNull"},
        "_id": {"$ref": "#/definitions/documentId"},
        "options": {
          "type": "array",
          "items": {"type": "string"}
        },
        "source": {
          "type": "string",
          "enum": ["Conservator", "Labelbox", "Unknown"]
        },
        "type": {
          "type": "string",
          "enum": ["dropdown", "radio", "checklist", "text"]
        },
        "attributePrototypeId": {"$ref": "#/definitions/documentId"}
      },
      "additionalProperties": false
    },
    "videoMetadata": {
      "$id": "#videoMetadata",
      "type": "object",
      "required": ["frameId", "frameIndex"],
      "properties": {
        "videoId": {"$ref": "#/definitions/documentId"},
        "frameId": {"$ref": "#/definitions/documentId"},
        "frameIndex": {"type": "integer"}
      },
      "additionalProperties": false
    }
  },

  "components": {
    "frame": {
      "$id": "#frame",
      "type": "object",
      "required": ["frameIndex"],
      "properties": {
        "frameIndex": {"type": "integer"},
        "datasetFrameId": {"$ref": "#/definitions/documentId"},
        "frameId": {"$ref": "#/definitions/documentId"},
        "videoId": {"$ref": "#/definitions/documentId"},
        "isEmpty": {"type": "boolean"},
        "isFlagged": {"type": "boolean"},
        "isItar": {"type": "boolean"},
        "qaStatus": {
          "type":  ["string", "null"],
          "enum": ["approved", "changesRequested", null]
        },
        "qaStatusNote": {"$ref": "#/definitions/noNull"},
        "md5": {"$ref": "#/definitions/md5hash"},
        "previewMd5": {"$ref": "#/definitions/md5hash"},
        "analyticsMd5": {"$ref": "#/definitions/md5hash"},
        "annotations": {
          "type": "array",
          "items": {"$ref": "#/definitions/annotation"}
        },
        "attributes": {
          "type": "array",
          "items": {"$ref": "#/definitions/attribute"}
        },
        "custom": {"$ref": "#/definitions/custom"}
      },
      "additionalProperties": false
    },

    "video": {
      "$id": "#video",
      "type": "object",
      "properties": {
        "id": {"$ref": "#/definitions/documentId"},
        "name": {"$ref": "#/definitions/noNull"},
        "filename": {"$ref": "#/definitions/noNull"},
        "spectrum": {"$ref": "#/definitions/noNull"},
        "description": {"$ref": "#/definitions/noNull"},
        "location": {"$ref": "#/definitions/noNull"},
        "tags": {
          "type": "array",
          "items": {"$ref": "#/definitions/tagString"}
        },
        "assetType": {"$ref": "#/definitions/noNull"},
        "frames": {
          "type": "array",
          "items": {"$ref": "#/components/frame"}
        },
        "isItar": {"type": "boolean"},
        "isRemoved": {"type": "boolean"},
        "owner": {"$ref": "#/definitions/email"},
        "custom": {"$ref": "#/definitions/custom"}
      },
      "additionalProperties": false
    },

    "datasetFrame": {
      "$id": "#datasetFrame",
      "type": "object",
      "required": ["datasetFrameId"],
      "properties": {
        "datasetFrameId": {"$ref": "#/definitions/documentId"},
        "isEmpty": {"type": "boolean"},
        "isFlagged": {"type": "boolean"},
        "qaStatus": {
          "type": ["string", "null"],
          "enum": ["approved", "changesRequested", null]
        },
        "qaStatusNote": {"$ref": "#/definitions/noNull"},
        "md5": {"$ref": "#/definitions/md5hash"},
        "previewMd5": {"$ref": "#/definitions/md5hash"},
        "analyticsMd5": {"$ref": "#/definitions/md5hash"},
        "annotations": {
          "type": "array",
          "items": {"$ref": "#/definitions/annotation"}
        },
        "attributes": {
          "type": "array",
          "items": {"$ref": "#/definitions/attribute"}
        },
        "tags": {
          "type": "array",
          "items": {"$ref": "#/definitions/tagString"}
        },
        "videoMetadata": {"$ref": "#/definitions/videoMetadata"},
        "height": {"$ref": "#/definitions/nonNegative"},
        "width": {"$ref": "#/definitions/nonNegative"},
        "fileSize": {"$ref": "#/definitions/nonNegative"},
        "spectrum": {"$ref": "#/definitions/noNull"},
        "description": {"$ref": "#/definitions/noNull"},
        "location": {"$ref": "#/definitions/noNull"},
        "isItar": {"type": "boolean"},
        "custom": {"$ref": "#/definitions/custom"}
      },
      "additionalProperties": false
    },

    "videoFile": {
      "comment": "*** subschema for video metadata file validation ***",
      "$id": "#videoFile",
      "type": "object",
      "required": ["version", "overwrite", "videos"],
      "properties": {
        "version": {
          "comment": "only version 1 is supported",
          "const": 1
        },
        "overwrite": {
          "comment": "only overwrite=true is supported",
          "const": true
        },
        "videos": {
          "type": "array",
          "items": {"$ref": "#/components/video"}
        }
      },
      "additionalProperties": true
    },

    "datasetFile": {
      "comment": "*** subschema for dataset metadata file validation ***",
      "$id": "#datasetFile",
      "type": "object",
      "required": ["datasetId", "datasetName", "version", "overwrite", "videos"],
      "properties": {
        "datasetId": {"$ref": "#/definitions/noNull"},
        "datasetName": {"$ref": "#/definitions/noNull"},
        "version": {
          "comment": "only version 1 is supported",
          "const": 1
        },
        "overwrite": {
          "comment": "only overwrite=true is supported",
          "const": true
        },
        "owner": {"$ref": "#/definitions/email"},
        "videos": {
          "type": "array",
          "items": {"$ref": "#/components/video"}
        },
        "frames": {
          "type": "array",
          "items": {"$ref": "#/components/datasetFrame"}
        },
        "description": {"type": "string"},
        "isItar": {"type": "boolean"},
        "custom": {"$ref": "#/definitions/custom"}
      },
      "additionalProperties": true
    }
  },

  "anyOf": [
    {"$ref": "#/components/datasetFile"}
  ]
}
